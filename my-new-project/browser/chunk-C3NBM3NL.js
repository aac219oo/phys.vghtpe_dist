import{a as M}from"./chunk-POQ5EUDY.js";import{a as I}from"./chunk-6EYC5ZPJ.js";import{a as d}from"./chunk-DDGGW3FN.js";import{H as S,N as m,R as h,U as l,Wb as u,e as y,h as c,o as p}from"./chunk-FMEZNCYJ.js";var n=(()=>{let i=class i{constructor(){this.app_ID="scbooks2022_"}setItem(t,e){localStorage.setItem(this.app_ID+t,e)}getItem(t){return localStorage.getItem(this.app_ID+t)}removeItem(t){localStorage.removeItem(this.app_ID+t)}clear(){localStorage.clear()}};i.USER="user",i.EXPIRED_DATE="local_expired_date",i.CART="cart",i.CART_EXPIRED_DATE="local_cart_expired_date",i.\u0275fac=function(e){return new(e||i)},i.\u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"});let a=i;return a})();var D=(()=>{let i=class i{constructor(t){this.http=t,this.url="assets/json/config.json",this.config$=this.http.get("assets/json/config.json").pipe(S(1),m(e=>this.config=e))}};i.\u0275fac=function(e){return new(e||i)(l(u))},i.\u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"});let a=i;return a})();var f=y(M());var v=y(M());var A=(()=>{let i=class i{constructor(){this.dateFormat="YYYY-MM-DD",this.dateSlash="YYYY/MM/DD",this.userFields=[{title:"\u6703\u54E1\u985E\u5225",from:"MembType",to:"memberType",update:"",type:"string"},{title:"\u6703\u54E1\u5230\u671F\u65E5",from:"MembTypeDate",to:"expiredDate",update:"",type:"DateString"},{title:"\u8A8D\u8B49\u72C0\u614B",from:"MembCheckStatus",to:"ckeckState",update:"",type:"string"},{title:"\u6703\u54E1\u7DE8\u865F",from:"MembSEQ",to:"id",update:"MemberSEQ",type:"string"},{title:"\u6703\u54E1\u4EE3\u865F",from:"MembTNo",to:"id2",update:"",type:"string"},{title:"\u5E33\u865F",from:"MembAcct",to:"account",update:"MemberAcct",type:"string"},{title:"\u5BC6\u78BC",from:"MembPass",to:"password",update:"MemberPass",type:"string"},{title:"\u59D3\u540D",from:"MembRealName",to:"realname",update:"RealName",type:"string"},{title:"\u66B1\u7A31",from:"MembPetName",to:"nickname",update:"PetName",type:"string"},{title:"\u6027\u5225",from:"MembSex",to:"sex",update:"Sex",type:"string"},{title:"\u751F\u65E5",from:"MembBirthDT",to:"birthday",update:"BirthDT",type:"DateString"},{title:"\u5B78\u6B77",from:"MembAntecedent",to:"antecedent",update:"Antecedent",type:"string"},{title:"\u7E23\u5E02",from:"MembAddressLocal",to:"city",update:"AddressLocal",type:"string"},{title:"\u5730\u5740",from:"MembAddress",to:"address",update:"Address",type:"string"},{title:"\u96FB\u8A71(H)\u5340\u865F",from:"MembHomeTelPost",to:"tel_h_post",update:"HomeTelPost",type:"string"},{title:"\u96FB\u8A71(H)",from:"MembHomeTelNumber",to:"tel_h",update:"HomeTelNumber",type:"string"},{title:"\u96FB\u8A71(O)\u5340\u865F",from:"MembOfficeTelPost",to:"tel_o_post",update:"OfficeTelPost",type:"string"},{title:"\u96FB\u8A71(O)",from:"MembOfficeTelNumber",to:"tel_o",update:"OfficeTelNumber",type:"string"},{title:"\u96FB\u8A71(O)\u5206\u6A5F",from:"MembOfficeTelExt",to:"tel_o_ext",update:"OfficeTelExt",type:"string"},{title:"\u624B\u6A5F",from:"MembMobile",to:"cellphone",update:"Mobile",type:"string"},{title:"e-mail",from:"MembeMail",to:"email",update:"eMail",type:"string"},{title:"\u8A02\u95B1\u96FB\u5B50\u5831",from:"MembePaper",to:"isSubscribed",update:"ePaper",type:"boolean"},{title:"\u6703\u54E1VIP",from:"Membisvip",to:"isVip",update:"isVip",type:"boolean"},{title:"VIP\u958B\u59CB",from:"VipStart",to:"VipStart",update:"",type:"DateString"},{title:"VIP\u7D50\u675F",from:"VipEnd",to:"VipEnd",update:"",type:"DateString"},{title:"\u4E09\u672C\u66F8\u514C\u63DB\u5238",from:"Membthreebooks",to:"usedVipCoupon",update:"Membthreebooks",type:"boolean"}]}transformData(t){if(t){var e={};return this.userFields.forEach((s,r)=>{switch(s.type){case"DateString":e[s.to]=(0,v.default)(new Date(t[s.from])).format(this.dateFormat);break;case"boolean":e[s.to]=t[s.from]?.toUpperCase()=="Y";break;default:e[s.to]=t[s.from];break}}),e}else return}transformJSONtoUser(t){if(t){var e=JSON.parse(t);return this.userFields.forEach((s,r)=>{switch(s.type){case"DateString":break;default:break}}),e}else return}transformDataToServer(t){var e=t,s={};return this.userFields.forEach((r,o)=>{if(r.update)switch(r.type){case"DateString":s[r.update]=e[r.to];break;case"boolean":s[r.update]=e[r.to]?"Y":"N";break;default:s[r.update]=e[r.to];break}}),s.Sex=="\u7537"?s.Sex="M":s.Sex=="\u5973"&&(s.Sex="F"),e.isVip?s.isVip="01":s.isVip="00",s}};i.\u0275fac=function(e){return new(e||i)},i.\u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"});let a=i;return a})();var x=class{constructor(){this.uploading=!1,this.isUploaded=!1,this.success=!1,this.hasError=!1}},F=(()=>{let i=class i{constructor(t,e,s,r,o){this.http=t,this.ud=e,this.ss=s,this.cs=r,this.ut=o,this.userAPI=d.ApiUrl+"api/MemberUser.aspx",this.updateAPI=d.ApiUrl+"api/memberuser_ins.aspx",this.userValidated=!1,this.userReceived=!1,this.redirectUrl="",this.isLogin=!1,this.isManager=!1,this.passwordChanged=!1,this.logoutAtStart=!1,this.loginToIndex=!1,this.cs.config$.subscribe(b=>{this.config=b}),this.loginAccount$=new c,this.loginName$=new c,this.isLogin$=new c,this.loginError$=new c,this.validated$=new c}uploadUser(t,e){var s=new URL(this.updateAPI),r=this.ud.transformDataToServer(t);switch(e){case"update":r.ACT="UPD";break;case"new":r.ACT="INS";break}var o=new URLSearchParams(r);return s.search=o.toString(),this.http.get(s.href).pipe()}startFromLocal(){var t=this.ss.getItem(n.EXPIRED_DATE);if(t&&(0,f.default)(t).isAfter((0,f.default)().format(this.ud.dateFormat))){var e=this.ss.getItem(n.USER),s=JSON.parse(e);this.loginFromLocal(e)}else this.logoutAtStart=!0,this.logout(),this.logoutAtStart=!1}getUserByID(t){var e=new URL(this.userAPI),s=new URLSearchParams({memno:t});return e.search=s.toString(),this.http.get(e.href).pipe(m(r=>console.log("from us id:",r)),p(r=>r[0]),p(r=>this.ud.transformData(r)))}getUserByMail(t){var e=new URL(this.userAPI),s=new URLSearchParams({mail:t});return e.search=s.toString(),this.http.get(e.href).pipe()}getUserByAccount(t,e){var s=new URL(this.userAPI),r=new URLSearchParams({ac:t,pa:e});return s.search=r.toString(),this.http.get(s.href).pipe(p(o=>o[0]),p(o=>this.ud.transformData(o)))}getUserByEmail(t){var e=new URL(this.userAPI),s=new URLSearchParams({mail:t});return e.search=s.toString(),this.http.get(e.href).pipe()}checkAccountValidated(t,e){return this.getUserByAccount(t,e).pipe(p(s=>s.ckeckState!="\u672A\u8A8D\u8B49"))}loginFromLocal(t){this.user=this.ud.transformJSONtoUser(t),this.isLogin=!0,this.checkManager(),this.notify(this.user?.account,this.user?.realname,!0,!1,!0,!0,!0)}checkManager(){this.cs.config$.subscribe(t=>{this.cs.config.webManagers.indexOf(this.user?.account)>=0&&(this.isManager=!0)})}login(t,e){return this.getUserByAccount(t,e).pipe(m(s=>{s?(this.userReceived=!0,s.ckeckState=="\u672A\u8A8D\u8B49"&&this.config.onlyValidated?(this.userValidated=!1,this.notify(void 0,void 0,!1,!1,!1,!1,!1)):(this.userValidated=!0,this.user=s,this.isLogin=!0,this.checkManager(),this.saveLocalData(),this.notify(this.user?.account,this.user?.realname,!0,!1,!0,!0,!0))):(console.log("\u627E\u4E0D\u5230\u4F7F\u7528\u8005"),this.notify("","",!1,!0,void 0,!1,!1))}))}updateLocalUser(t){this.user=t,this.saveLocalData(),this.notify(this.user?.account,this.user?.realname,!0,!1,!0,!0,!0)}saveLocalData(){this.ss.setItem(n.USER,JSON.stringify(this.user)),this.ss.setItem(n.EXPIRED_DATE,(0,f.default)().add(this.config.localExpiredDays,"days").format(this.ud.dateFormat))}clearLocalData(){this.ss.removeItem(n.USER),this.ss.removeItem(n.EXPIRED_DATE)}logout(){this.user=void 0,this.isLogin=!1,this.isManager=!1,this.notify("","",!1,!1,void 0,!1,!1),this.clearLocalData(),this.logoutAtStart||this.ut.navigate("/login")}notify(t,e,s,r,o,b,w){this.loginAccount$.next(t),this.loginName$.next(e),this.isLogin$.next(s),this.loginError$.next(r),this.validated$.next(o)}};i.\u0275fac=function(e){return new(e||i)(l(u),l(A),l(n),l(D),l(I))},i.\u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"});let a=i;return a})();export{n as a,D as b,x as c,F as d};
